import { jsx, Fragment } from 'react/jsx-runtime';
import { memo, useMemo } from 'react';
import { isRemoteReceiverAttachableFragment, KIND_TEXT, KIND_COMPONENT } from '@remote-ui/core';
import { useAttached } from './hooks.esnext';

const emptyObject = {};
function renderComponent({
  component,
  controller,
  receiver,
  key
}) {
  return /*#__PURE__*/jsx(RemoteComponent, {
    receiver: receiver,
    component: component,
    controller: controller
  }, key);
}
const RemoteComponent = /*#__PURE__*/memo(({
  receiver,
  component,
  controller
}) => {
  const Implementation = controller.get(component.type);
  const attached = useAttached(receiver, component);
  const props = useMemo(() => {
    const props = attached === null || attached === void 0 ? void 0 : attached.props;
    if (!props) return emptyObject;
    const newProps = {};

    for (const key of Object.keys(props)) {
      const prop = props[key];
      newProps[key] = isRemoteReceiverAttachableFragment(prop) ? /*#__PURE__*/jsx(RemoteFragment, {
        receiver: receiver,
        fragment: prop,
        controller: controller
      }) : prop;
    }

    return newProps;
  }, [receiver, controller, attached === null || attached === void 0 ? void 0 : attached.props, component.version]);
  if (attached == null) return null;
  const {
    children
  } = attached;
  return /*#__PURE__*/jsx(Implementation, { ...props,
    children: renderChildren(children, receiver, controller)
  });
});
const RemoteFragment = /*#__PURE__*/memo(({
  receiver,
  fragment,
  controller
}) => {
  var _useAttached;

  const {
    children
  } = (_useAttached = useAttached(receiver, fragment)) !== null && _useAttached !== void 0 ? _useAttached : {};
  if (!children) return null;
  return /*#__PURE__*/jsx(Fragment, {
    children: renderChildren(children, receiver, controller)
  });
});

function renderChildren(children, receiver, controller) {
  const {
    renderComponent,
    renderText
  } = controller.renderer;
  return [...children].map(child => {
    switch (child.kind) {
      case KIND_COMPONENT:
        return renderComponent({
          component: child,
          receiver,
          controller,
          key: child.id
        });

      case KIND_TEXT:
        return renderText({
          text: child,
          receiver,
          key: child.id
        });

      default:
        return null;
    }
  });
}

export { RemoteComponent, renderComponent };
